image: node:20

stages:
  - setup
  - validate
  - test:utils
  - test:commands
  - test:scripts
  - test:integration

# Setup stage - Install dependencies
setup-dependencies:
  stage: setup
  only:
    - merge_requests
    - main
    - master
  variables:
    DISCORD_TOKEN: 'ci-test-token'
    CLIENT_ID: 'ci-test-client-id'
  script:
    - npm ci
  cache:
    paths:
      - node_modules/
    key: ${CI_COMMIT_REF_SLUG}
    policy: push

# Validate stage - Code quality checks
validate-code:
  stage: validate
  only:
    - merge_requests
    - main
    - master
  variables:
    DISCORD_TOKEN: 'ci-test-token'
    CLIENT_ID: 'ci-test-client-id'
  cache:
    paths:
      - node_modules/
    key: ${CI_COMMIT_REF_SLUG}
    policy: pull
  script:
    - npm run validate
  dependencies:
    - setup-dependencies

# Test stage - Utility functions
test-utils:
  stage: test:utils
  only:
    - merge_requests
    - main
    - master
  variables:
    DISCORD_TOKEN: 'ci-test-token'
    CLIENT_ID: 'ci-test-client-id'
  cache:
    paths:
      - node_modules/
    key: ${CI_COMMIT_REF_SLUG}
    policy: pull
  script:
    - set +e
    - rm -rf test-utils.xml
    - npx cross-env R2_ACCOUNT_ID= R2_ACCESS_KEY_ID= R2_SECRET_ACCESS_KEY= R2_BUCKET_NAME= node --test --test-reporter tap test/utils/ > test-utils.tap
    - TEST_EXIT_CODE=$?
    - echo "TAP file size: $(wc -c < test-utils.tap) bytes"
    - head -20 test-utils.tap || true
    - npx tap-junit test-utils.tap -o test-utils.xml 2>&1 || TAP_JUNIT_FAILED=true
    - if [ -d test-utils.xml ]; then rm -rf test-utils.xml; fi
    - |
      if [ -f test-utils.xml ]; then
        XML_SIZE=$(wc -c < test-utils.xml);
        HAS_TESTS=$(grep -c "<testsuite" test-utils.xml 2>/dev/null || echo "0");
        echo "XML file size: $XML_SIZE bytes, test suites: $HAS_TESTS";
        if [ "$XML_SIZE" -lt 200 ] || [ "$HAS_TESTS" -eq "0" ]; then
          echo "XML file appears empty or invalid, tap-junit conversion may have failed";
          TAP_JUNIT_FAILED=true;
        fi;
      fi
    - if [ ! -f test-utils.xml ] || [ "$TAP_JUNIT_FAILED" = "true" ]; then echo '<?xml version="1.0" encoding="UTF-8"?><testsuites></testsuites>' > test-utils.xml; fi
    - test -f test-utils.xml && ls -la test-utils.xml
    - exit $TEST_EXIT_CODE
  artifacts:
    when: always
    paths:
      - test-utils.xml
    reports:
      junit: test-utils.xml
  dependencies:
    - setup-dependencies

# Test stage - Command handlers
test-commands:
  stage: test:commands
  only:
    - merge_requests
    - main
    - master
  variables:
    DISCORD_TOKEN: 'ci-test-token'
    CLIENT_ID: 'ci-test-client-id'
  cache:
    paths:
      - node_modules/
    key: ${CI_COMMIT_REF_SLUG}
    policy: pull
  script:
    - set +e
    - rm -rf test-commands.xml
    - npx cross-env R2_ACCOUNT_ID= R2_ACCESS_KEY_ID= R2_SECRET_ACCESS_KEY= R2_BUCKET_NAME= node --test --test-reporter tap test/commands/ > test-commands.tap
    - TEST_EXIT_CODE=$?
    - echo "TAP file size: $(wc -c < test-commands.tap) bytes"
    - head -20 test-commands.tap || true
    - npx tap-junit test-commands.tap -o test-commands.xml 2>&1 || TAP_JUNIT_FAILED=true
    - if [ -d test-commands.xml ]; then rm -rf test-commands.xml; fi
    - |
      if [ -f test-commands.xml ]; then
        XML_SIZE=$(wc -c < test-commands.xml);
        HAS_TESTS=$(grep -c "<testsuite" test-commands.xml 2>/dev/null || echo "0");
        echo "XML file size: $XML_SIZE bytes, test suites: $HAS_TESTS";
        if [ "$XML_SIZE" -lt 200 ] || [ "$HAS_TESTS" -eq "0" ]; then
          echo "XML file appears empty or invalid, tap-junit conversion may have failed";
          TAP_JUNIT_FAILED=true;
        fi;
      fi
    - if [ ! -f test-commands.xml ] || [ "$TAP_JUNIT_FAILED" = "true" ]; then echo '<?xml version="1.0" encoding="UTF-8"?><testsuites></testsuites>' > test-commands.xml; fi
    - test -f test-commands.xml && ls -la test-commands.xml
    - exit $TEST_EXIT_CODE
  artifacts:
    when: always
    paths:
      - test-commands.xml
    reports:
      junit: test-commands.xml
  dependencies:
    - setup-dependencies

# Test stage - Scripts
test-scripts:
  stage: test:scripts
  only:
    - merge_requests
    - main
    - master
  variables:
    DISCORD_TOKEN: 'ci-test-token'
    CLIENT_ID: 'ci-test-client-id'
  cache:
    paths:
      - node_modules/
    key: ${CI_COMMIT_REF_SLUG}
    policy: pull
  script:
    - set +e
    - rm -rf test-scripts.xml
    - npx cross-env R2_ACCOUNT_ID= R2_ACCESS_KEY_ID= R2_SECRET_ACCESS_KEY= R2_BUCKET_NAME= node --test --test-reporter tap test/scripts/ > test-scripts.tap
    - TEST_EXIT_CODE=$?
    - echo "TAP file size: $(wc -c < test-scripts.tap) bytes"
    - head -20 test-scripts.tap || true
    - npx tap-junit test-scripts.tap -o test-scripts.xml 2>&1 || TAP_JUNIT_FAILED=true
    - if [ -d test-scripts.xml ]; then rm -rf test-scripts.xml; fi
    - |
      if [ -f test-scripts.xml ]; then
        XML_SIZE=$(wc -c < test-scripts.xml);
        HAS_TESTS=$(grep -c "<testsuite" test-scripts.xml 2>/dev/null || echo "0");
        echo "XML file size: $XML_SIZE bytes, test suites: $HAS_TESTS";
        if [ "$XML_SIZE" -lt 200 ] || [ "$HAS_TESTS" -eq "0" ]; then
          echo "XML file appears empty or invalid, tap-junit conversion may have failed";
          TAP_JUNIT_FAILED=true;
        fi;
      fi
    - if [ ! -f test-scripts.xml ] || [ "$TAP_JUNIT_FAILED" = "true" ]; then echo '<?xml version="1.0" encoding="UTF-8"?><testsuites></testsuites>' > test-scripts.xml; fi
    - test -f test-scripts.xml && ls -la test-scripts.xml
    - exit $TEST_EXIT_CODE
  artifacts:
    when: always
    paths:
      - test-scripts.xml
    reports:
      junit: test-scripts.xml
  dependencies:
    - setup-dependencies

# Test stage - Integration/server components
test-integration:
  stage: test:integration
  only:
    - merge_requests
    - main
    - master
  variables:
    DISCORD_TOKEN: 'ci-test-token'
    CLIENT_ID: 'ci-test-client-id'
  cache:
    paths:
      - node_modules/
    key: ${CI_COMMIT_REF_SLUG}
    policy: pull
  script:
    - set +e
    - rm -rf test-integration.xml
    - npx cross-env R2_ACCOUNT_ID= R2_ACCESS_KEY_ID= R2_SECRET_ACCESS_KEY= R2_BUCKET_NAME= node --test --test-reporter tap test/webui-server-*.test.js test/docker-security.test.js > test-integration.tap
    - TEST_EXIT_CODE=$?
    - echo "TAP file size: $(wc -c < test-integration.tap) bytes"
    - head -20 test-integration.tap || true
    - npx tap-junit test-integration.tap -o test-integration.xml 2>&1 || TAP_JUNIT_FAILED=true
    - if [ -d test-integration.xml ]; then rm -rf test-integration.xml; fi
    - |
      if [ -f test-integration.xml ]; then
        XML_SIZE=$(wc -c < test-integration.xml);
        HAS_TESTS=$(grep -c "<testsuite" test-integration.xml 2>/dev/null || echo "0");
        echo "XML file size: $XML_SIZE bytes, test suites: $HAS_TESTS";
        if [ "$XML_SIZE" -lt 200 ] || [ "$HAS_TESTS" -eq "0" ]; then
          echo "XML file appears empty or invalid, tap-junit conversion may have failed";
          TAP_JUNIT_FAILED=true;
        fi;
      fi
    - if [ ! -f test-integration.xml ] || [ "$TAP_JUNIT_FAILED" = "true" ]; then echo '<?xml version="1.0" encoding="UTF-8"?><testsuites></testsuites>' > test-integration.xml; fi
    - test -f test-integration.xml && ls -la test-integration.xml
    - exit $TEST_EXIT_CODE
  artifacts:
    when: always
    paths:
      - test-integration.xml
    reports:
      junit: test-integration.xml
  dependencies:
    - setup-dependencies
