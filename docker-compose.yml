services:
  app:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        BUILD_TIMESTAMP: ${BUILD_TIMESTAMP:-}
        GIT_COMMIT: ${GIT_COMMIT:-}
    container_name: gronka
    restart: unless-stopped
    depends_on:
      postgres:
        condition: service_healthy
    environment:
      - DISCORD_TOKEN=${DISCORD_TOKEN}
      - CLIENT_ID=${CLIENT_ID}
      - CDN_BASE_URL=${CDN_BASE_URL:-https://cdn.gronka.p1x.dev/gifs}
      - SERVER_PORT=${SERVER_PORT:-3000}
      - GIF_STORAGE_PATH=${GIF_STORAGE_PATH:-./data-prod/gifs}
      - MAX_GIF_WIDTH=${MAX_GIF_WIDTH:-}
      - MAX_GIF_DURATION=${MAX_GIF_DURATION:-30}
      - DEFAULT_FPS=${DEFAULT_FPS:-}
      - MAX_VIDEO_SIZE=${MAX_VIDEO_SIZE:-}
      - MAX_IMAGE_SIZE=${MAX_IMAGE_SIZE:-}
      - GIF_QUALITY=${GIF_QUALITY:-medium}
      - ADMIN_USER_IDS=${ADMIN_USER_IDS:-}
      - STATS_USERNAME=${STATS_USERNAME:-}
      - STATS_PASSWORD=${STATS_PASSWORD:-}
      - STATS_CACHE_TTL=${STATS_CACHE_TTL:-}
      - COBALT_API_URL=${COBALT_API_URL:-http://cobalt:9000}
      - COBALT_ENABLED=${COBALT_ENABLED:-true}
      - R2_ACCOUNT_ID=${R2_ACCOUNT_ID:-}
      - R2_ACCESS_KEY_ID=${R2_ACCESS_KEY_ID:-}
      - R2_SECRET_ACCESS_KEY=${R2_SECRET_ACCESS_KEY:-}
      - R2_BUCKET_NAME=${R2_BUCKET_NAME:-}
      - R2_PUBLIC_DOMAIN=${R2_PUBLIC_DOMAIN:-cdn.gronka.p1x.dev}
      - R2_TEMP_UPLOADS_ENABLED=${R2_TEMP_UPLOADS_ENABLED:-}
      - R2_TEMP_UPLOAD_TTL_HOURS=${R2_TEMP_UPLOAD_TTL_HOURS:-}
      - R2_CLEANUP_ENABLED=${R2_CLEANUP_ENABLED:-}
      - R2_CLEANUP_INTERVAL_MS=${R2_CLEANUP_INTERVAL_MS:-}
      - R2_CLEANUP_LOG_LEVEL=${R2_CLEANUP_LOG_LEVEL:-}
      - NTFY_TOPIC=${NTFY_TOPIC:-}
      - CLOUDFLARE_API_TOKEN=${CLOUDFLARE_API_TOKEN:-}
      - CLOUDFLARE_ACCOUNT_ID=${CLOUDFLARE_ACCOUNT_ID:-}
      - CLOUDFLARE_KV_NAMESPACE_ID=${CLOUDFLARE_KV_NAMESPACE_ID:-}
      - CLOUDFLARE_PAGES_PROJECT_NAME=${CLOUDFLARE_PAGES_PROJECT_NAME:-}
      - LOG_LEVEL=${LOG_LEVEL:-}
      - LOG_DIR=${LOG_DIR:-}
      - LOG_ROTATION=${LOG_ROTATION:-}
      - SERVER_HOST=${SERVER_HOST:-}
      - WEBUI_PORT=${WEBUI_PORT:-3001}
      - WEBUI_HOST=${WEBUI_HOST:-0.0.0.0}
      - POSTGRES_HOST=${POSTGRES_HOST:-postgres}
      - POSTGRES_PORT=${POSTGRES_PORT:-5432}
      - POSTGRES_USER=${POSTGRES_USER:-gronka}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-gronka}
      - POSTGRES_DB=${POSTGRES_DB:-gronka}
      - DATABASE_URL=${DATABASE_URL:-}
    volumes:
      - ./data-test:/app/data-test
      - ./data-prod:/app/data-prod
      - ./temp:/app/temp
      - ./logs:/app/logs
      - /var/run/docker.sock:/var/run/docker.sock
    ports:
      - '${SERVER_PORT:-3000}:${SERVER_PORT:-3000}'
      - '${WEBUI_PORT:-3001}:${WEBUI_PORT:-3001}'
    networks:
      - gronka-network
    healthcheck:
      test: ['CMD-SHELL', 'pgrep -f "node.*src/bot.js" > /dev/null || exit 1']
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 10s

  postgres:
    image: postgres:16-alpine
    container_name: gronka-postgres
    restart: unless-stopped
    environment:
      - POSTGRES_USER=${POSTGRES_USER:-gronka}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-gronka}
      - POSTGRES_DB=${POSTGRES_DB:-gronka}
      - PGDATA=/var/lib/postgresql/data/pgdata
    volumes:
      - postgres-data:/var/lib/postgresql/data
    ports:
      - '${POSTGRES_PORT:-5432}:5432'
    networks:
      - gronka-network
    healthcheck:
      test: ['CMD-SHELL', 'pg_isready -U ${POSTGRES_USER:-gronka} -d ${POSTGRES_DB:-gronka}']
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

  cobalt:
    image: ghcr.io/imputnet/cobalt:11
    init: true
    read_only: true
    restart: unless-stopped
    container_name: cobalt
    ports:
      # Exposed for internal Docker network access
      # If you want to restrict to localhost only, use: - 127.0.0.1:9000:9000/tcp
      - 9000:9000/tcp
    environment:
      API_URL: ${COBALT_API_URL:-http://cobalt:9000}
      # Path to cookies.json file for authenticating with services (Twitter, Instagram, Reddit, etc.)
      # Required for accessing content that requires authentication
      COOKIE_PATH: '/cookies.json'
    labels:
      - com.centurylinklabs.watchtower.scope=cobalt
    networks:
      - gronka-network
    volumes:
      # Mount cookies.json from project root to enable authentication for restricted content
      # Create cookies.json from cookies.example.json and add your service authentication cookies
      - ./cookies.json:/cookies.json

  giflossy:
    image: dylanninin/giflossy:latest
    container_name: giflossy
    restart: unless-stopped
    volumes:
      - ./data-test:/app/data-test
      - ./data-prod:/app/data-prod
      - ./temp:/app/temp
    networks:
      - gronka-network
    # Note: This service is used for GIF optimization via docker exec

  # watchtower updates the cobalt image automatically
  watchtower:
    image: ghcr.io/containrrr/watchtower:latest
    restart: unless-stopped
    command: --cleanup --scope cobalt --interval 900 --include-restarting
    environment:
      - DOCKER_API_VERSION=1.52
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    networks:
      - gronka-network

  # if needed, use this image for automatically generating poToken & visitor_data
  # yt-session-generator:
  #   image: ghcr.io/imputnet/yt-session-generator:webserver
  #   init: true
  #   restart: unless-stopped
  #   container_name: yt-session-generator
  #   labels:
  #     - com.centurylinklabs.watchtower.scope=cobalt
  #   networks:
  #     - gronka-network

volumes:
  postgres-data:
    driver: local

networks:
  gronka-network:
    driver: bridge
